@{
    ViewBag.Title = "Chat";
}

<div class="row" style="height:70%">
    <div class="col-xs-8 col-sm-9 col-md-9">
        <div  style="height:290px; width:100%; border:1px solid black; overflow:auto ; background-color:gray">
           <div class="board" style="width:720px; height:300px; margin:10px; background-color:lightblue">
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div><div class="someone"> </div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div>
                <div> </div> 
            </div>
        </div>
    </div>
     <div class="col-xs-4 col-sm-3 col-md-3"  >
        <div id="userList" style="height: 290px; border : 1px solid #d5d5d5">
          <!--  <div class="userOnline">
                <div style="width:40px"><img src="~/Images/orderedList9.png" alt="" /></div> <div style="display:inline"><a href="#">GohamMF</a></div>
            </div>
            <div  class="userOnline">
                <div style="width:40px"><img src="~/Images/orderedList8.png" alt="" /></div><div style="display:inline"> <a href="#">Zé</a></div>
            </div>
            <div class="userOnline">
                <div style="width:40px"><img src="~/Images/orderedList7.png" alt="" /></div><div style="display:inline" ><a href="#">Antonio Manuel dos Santos zezinhos</a></div>
            </div> -->
        </div>
    </div> 
      
</div>
<div class="row clear">
    <div class="col-sm-6">
        cenas dads etc
    </div>
    <div class="col-sm-6 " style="height:100px; vertical-align:bottom">
        <div style="height: 85%; overflow:auto ">
            <ul id="discussion"></ul>
        </div>
        <div style="height:30px; margin-top:10px" class="row" >
            <div style="display:inline" class="col-md-10">
                <input type="text" id= "message" style="width:100%" />
            </div>
            <div style="display:inline ; margin-right:20px " class="pull-right">
                <input type="button" class="btn btn-sm" id="sendmessage" value="send" />
            </div>
        </div>
    </div>
</div>
@section scripts{
     <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-1.1.3.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.--> 
    <script>
        $(function () {
            // Reference the auto-generated proxy for the hub.  
            var chat = $.connection.chatHub;
            // Regier clients methods
            
            registerClientMethods(chat);
            
            // Start the connection.
            $.connection.hub.start().done(function () {
                // when users logged in correctly
                chat.server.connect('@User.Identity.Name')
                $('#sendmessage').click(function () {
                    // Call the Send method on the hub. 
                    var msg = $('#message').val();
                    var name ='@User.Identity.Name'
                    chat.server.sendMessageToAll(name, msg);
                     // Clear text box and reset focus for next comment. 
                    $('#message').val('').focus();

                });

            });
            
        });

      

        function registerClientMethods(chat) {

            // Create a function that the hub can call back to display messages.
            chat.client.addNewMessageToPage = function (name, message) {
                // Add the message to the page. 
                AddMessage(name, message);
               
            };


            //Calls when user successfuly logged in
            chat.client.onConnected = function (allUsers, messages) {

                for (i = 0 ; i < allUsers.length; i++) {
                    AddUsers(allUsers[i].connectionId,allUsers[i].userName)
                }
                for (i = 0 ; i < messages.length; i++) {
                    AddMessage(messages[i].userName, messages[i].message)
                }
            };

            // on new User Connected
            chat.client.onNewUserConnected = function (id, name) {
                AddUsers(id, name);
            };

        }

        function AddMessage(name, message) {

            $('#discussion').append('<li><strong>' + htmlEncode(name)
               + '</strong>: ' + htmlEncode(message) + '</li>');
        }

        function AddUsers(id, name) {
            alert("dahdadadada")
            $('#userList').append($('<div id="' + id + '" class="userOnline">'
           + '<div style="width:40px"><img src="../Images/orderedList9.png" alt="" /></div>'
           + '<div style="display:inline"><a href="#">' + name + '</a></div>'
           + '</div>')
          );
        }

       

        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>
    }